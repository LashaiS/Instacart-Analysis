{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 1,
   "id": "696b26f2-8785-4c3c-adb9-76499a79e477",
   "metadata": {},
   "outputs": [],
   "source": [
    "# import libraries\n",
    "import pandas as pd\n",
    "import numpy as np\n",
    "import os\n",
    "import matplotlib.pyplot as plt\n",
    "import seaborn as sns\n",
    "import scipy"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "0a94347b-187e-49c6-ba2b-878de5bcc613",
   "metadata": {},
   "outputs": [],
   "source": [
    "instacart = pd.read_pickle(r\"C:\\Users\\shais\\Documents\\01-12-2026 Instacart Basket Analysis\\02 Data\\Prepared Data\\instacart_active_customer.pkl\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "id": "a81e76ba-1503-4e49-a8ad-50bdd67940c1",
   "metadata": {},
   "outputs": [],
   "source": [
    "instacart_active = instacart.drop(columns=[\"low_activity_flag\"])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "id": "7b0e911d-2e7e-4719-9ff5-e0094ccff031",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "Index(['user_id', 'gender', 'state', 'age', 'date_joined', 'n_dependants',\n",
       "       'fam_status', 'income', '    ', 'order_id', 'order_number',\n",
       "       'orders_day_of_week', 'order_hour_of_day', 'days_since_prior_order',\n",
       "       'product_id', 'add_to_cart_order', 'reordered', 'product_name',\n",
       "       'aisle_id', 'department_id', 'prices', 'price_range_loc', 'max_order',\n",
       "       'loyalty_flag', 'avg_price', 'spending_flag', 'median_days',\n",
       "       'frequency_flag', 'region', 'order_count', 'exclusion_flag'],\n",
       "      dtype='object')"
      ]
     },
     "execution_count": 4,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "instacart_active.columns"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "id": "66cfd805-df4f-43b6-9403-0ba1ad5cf9a2",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>user_id</th>\n",
       "      <th>gender</th>\n",
       "      <th>state</th>\n",
       "      <th>age</th>\n",
       "      <th>date_joined</th>\n",
       "      <th>n_dependants</th>\n",
       "      <th>fam_status</th>\n",
       "      <th>income</th>\n",
       "      <th></th>\n",
       "      <th>order_id</th>\n",
       "      <th>...</th>\n",
       "      <th>price_range_loc</th>\n",
       "      <th>max_order</th>\n",
       "      <th>loyalty_flag</th>\n",
       "      <th>avg_price</th>\n",
       "      <th>spending_flag</th>\n",
       "      <th>median_days</th>\n",
       "      <th>frequency_flag</th>\n",
       "      <th>region</th>\n",
       "      <th>order_count</th>\n",
       "      <th>exclusion_flag</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>26711</td>\n",
       "      <td>Female</td>\n",
       "      <td>Missouri</td>\n",
       "      <td>48</td>\n",
       "      <td>1/1/2017</td>\n",
       "      <td>3</td>\n",
       "      <td>married</td>\n",
       "      <td>165665</td>\n",
       "      <td>443891</td>\n",
       "      <td>518967</td>\n",
       "      <td>...</td>\n",
       "      <td>Low-range product</td>\n",
       "      <td>8</td>\n",
       "      <td>New customer</td>\n",
       "      <td>7.988889</td>\n",
       "      <td>Low Spender</td>\n",
       "      <td>19.0</td>\n",
       "      <td>Regular customer</td>\n",
       "      <td>Midwest</td>\n",
       "      <td>8</td>\n",
       "      <td>active</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>26711</td>\n",
       "      <td>Female</td>\n",
       "      <td>Missouri</td>\n",
       "      <td>48</td>\n",
       "      <td>1/1/2017</td>\n",
       "      <td>3</td>\n",
       "      <td>married</td>\n",
       "      <td>165665</td>\n",
       "      <td>443892</td>\n",
       "      <td>423547</td>\n",
       "      <td>...</td>\n",
       "      <td>Mid-range product</td>\n",
       "      <td>8</td>\n",
       "      <td>New customer</td>\n",
       "      <td>7.988889</td>\n",
       "      <td>Low Spender</td>\n",
       "      <td>19.0</td>\n",
       "      <td>Regular customer</td>\n",
       "      <td>Midwest</td>\n",
       "      <td>8</td>\n",
       "      <td>active</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>26711</td>\n",
       "      <td>Female</td>\n",
       "      <td>Missouri</td>\n",
       "      <td>48</td>\n",
       "      <td>1/1/2017</td>\n",
       "      <td>3</td>\n",
       "      <td>married</td>\n",
       "      <td>165665</td>\n",
       "      <td>443893</td>\n",
       "      <td>2524893</td>\n",
       "      <td>...</td>\n",
       "      <td>Mid-range product</td>\n",
       "      <td>8</td>\n",
       "      <td>New customer</td>\n",
       "      <td>7.988889</td>\n",
       "      <td>Low Spender</td>\n",
       "      <td>19.0</td>\n",
       "      <td>Regular customer</td>\n",
       "      <td>Midwest</td>\n",
       "      <td>8</td>\n",
       "      <td>active</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>26711</td>\n",
       "      <td>Female</td>\n",
       "      <td>Missouri</td>\n",
       "      <td>48</td>\n",
       "      <td>1/1/2017</td>\n",
       "      <td>3</td>\n",
       "      <td>married</td>\n",
       "      <td>165665</td>\n",
       "      <td>443893</td>\n",
       "      <td>2524893</td>\n",
       "      <td>...</td>\n",
       "      <td>Low-range product</td>\n",
       "      <td>8</td>\n",
       "      <td>New customer</td>\n",
       "      <td>7.988889</td>\n",
       "      <td>Low Spender</td>\n",
       "      <td>19.0</td>\n",
       "      <td>Regular customer</td>\n",
       "      <td>Midwest</td>\n",
       "      <td>8</td>\n",
       "      <td>active</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>26711</td>\n",
       "      <td>Female</td>\n",
       "      <td>Missouri</td>\n",
       "      <td>48</td>\n",
       "      <td>1/1/2017</td>\n",
       "      <td>3</td>\n",
       "      <td>married</td>\n",
       "      <td>165665</td>\n",
       "      <td>443893</td>\n",
       "      <td>2524893</td>\n",
       "      <td>...</td>\n",
       "      <td>Mid-range product</td>\n",
       "      <td>8</td>\n",
       "      <td>New customer</td>\n",
       "      <td>7.988889</td>\n",
       "      <td>Low Spender</td>\n",
       "      <td>19.0</td>\n",
       "      <td>Regular customer</td>\n",
       "      <td>Midwest</td>\n",
       "      <td>8</td>\n",
       "      <td>active</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>5 rows × 31 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "   user_id  gender     state  age date_joined  n_dependants fam_status  \\\n",
       "0    26711  Female  Missouri   48    1/1/2017             3    married   \n",
       "1    26711  Female  Missouri   48    1/1/2017             3    married   \n",
       "2    26711  Female  Missouri   48    1/1/2017             3    married   \n",
       "3    26711  Female  Missouri   48    1/1/2017             3    married   \n",
       "4    26711  Female  Missouri   48    1/1/2017             3    married   \n",
       "\n",
       "   income          order_id  ...    price_range_loc  max_order  loyalty_flag  \\\n",
       "0  165665  443891    518967  ...  Low-range product          8  New customer   \n",
       "1  165665  443892    423547  ...  Mid-range product          8  New customer   \n",
       "2  165665  443893   2524893  ...  Mid-range product          8  New customer   \n",
       "3  165665  443893   2524893  ...  Low-range product          8  New customer   \n",
       "4  165665  443893   2524893  ...  Mid-range product          8  New customer   \n",
       "\n",
       "   avg_price  spending_flag  median_days    frequency_flag   region  \\\n",
       "0   7.988889    Low Spender         19.0  Regular customer  Midwest   \n",
       "1   7.988889    Low Spender         19.0  Regular customer  Midwest   \n",
       "2   7.988889    Low Spender         19.0  Regular customer  Midwest   \n",
       "3   7.988889    Low Spender         19.0  Regular customer  Midwest   \n",
       "4   7.988889    Low Spender         19.0  Regular customer  Midwest   \n",
       "\n",
       "   order_count  exclusion_flag  \n",
       "0            8          active  \n",
       "1            8          active  \n",
       "2            8          active  \n",
       "3            8          active  \n",
       "4            8          active  \n",
       "\n",
       "[5 rows x 31 columns]"
      ]
     },
     "execution_count": 5,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "# step 5: making customer profiles\n",
    "instacart_active.shape\n",
    "instacart_active.head()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 9,
   "id": "2656ac38-b1a3-4d09-898d-e9ccbd2cd79e",
   "metadata": {},
   "outputs": [],
   "source": [
    "#create age groups\n",
    "def age_group(age):\n",
    "    if age < 25: \n",
    "        return \"Young adult\"\n",
    "    elif age < 40:\n",
    "        return \"Adult\"\n",
    "    elif age < 60:\n",
    "        return \"Middle age\"\n",
    "    elif age:\n",
    "        return \"Senior\""
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "id": "d9e256a1-9ac5-4c3c-abac-62a762bb8aa9",
   "metadata": {},
   "outputs": [],
   "source": [
    "instacart_active[\"age_group\"] = instacart_active[\"age\"].apply(age_group)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "id": "2de6be7b-c45c-442d-b4e9-4a8c889e8d5a",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "age_group\n",
       "Senior         3233788\n",
       "Middle age     2971843\n",
       "Adult          2240386\n",
       "Young adult    1042729\n",
       "Name: count, dtype: int64"
      ]
     },
     "execution_count": 8,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "instacart_active[\"age_group\"].value_counts()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 11,
   "id": "ba9a0ccb-ff27-4a89-bdb6-3ccb2dbaf0fb",
   "metadata": {},
   "outputs": [],
   "source": [
    "# create income groups\n",
    "def income_group(income):\n",
    "    if income <40000:\n",
    "        return \"Low Income\"\n",
    "    elif income < 80000:\n",
    "        return \" Middle income\"\n",
    "    else:\n",
    "        return \"High income\""
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 12,
   "id": "add34f6b-6d98-47ae-bc71-0a20b2a6b4c5",
   "metadata": {},
   "outputs": [],
   "source": [
    "instacart_active[\"income_group\"] = instacart_active[\"income\"].apply(income_group)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 13,
   "id": "552b84c3-973c-4f57-be4e-a0811a6f8a55",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "income_group\n",
       "High income       6080740\n",
       " Middle income    2891251\n",
       "Low Income         516755\n",
       "Name: count, dtype: int64"
      ]
     },
     "execution_count": 13,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "instacart_active[\"income_group\"].value_counts()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 15,
   "id": "2dd956f9-50b8-4678-9fa6-48f033d5ed70",
   "metadata": {},
   "outputs": [],
   "source": [
    "# create family/dependent group\n",
    "instacart_active[\"family_status\"] = instacart_active[\"n_dependants\"].apply( lambda x: \"No dependents\" if x --0 else \"Has dependents\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 16,
   "id": "a00b5bb6-b422-498f-96bc-dda8dc41ff50",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "family_status\n",
       "No dependents     7145897\n",
       "Has dependents    2342849\n",
       "Name: count, dtype: int64"
      ]
     },
     "execution_count": 16,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "instacart_active[\"family_status\"].value_counts()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 17,
   "id": "b0b64005-9c78-4bdd-b4cc-fe0d9a787dc1",
   "metadata": {},
   "outputs": [],
   "source": [
    "# what does each customer buy the most?: count department purchase per customer\n",
    "dept_counts = (instacart_active.groupby([\"user_id\", \"department_id\"]).size().reset_index(name=\"count\"))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 18,
   "id": "9b430091-4166-436e-9e58-9d40cd7b4b64",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>user_id</th>\n",
       "      <th>department_id</th>\n",
       "      <th>count</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>1</td>\n",
       "      <td>4.0</td>\n",
       "      <td>5</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>1</td>\n",
       "      <td>7.0</td>\n",
       "      <td>13</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>1</td>\n",
       "      <td>13.0</td>\n",
       "      <td>1</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>1</td>\n",
       "      <td>14.0</td>\n",
       "      <td>3</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>1</td>\n",
       "      <td>16.0</td>\n",
       "      <td>13</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "   user_id  department_id  count\n",
       "0        1            4.0      5\n",
       "1        1            7.0     13\n",
       "2        1           13.0      1\n",
       "3        1           14.0      3\n",
       "4        1           16.0     13"
      ]
     },
     "execution_count": 18,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "dept_counts.head()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 19,
   "id": "7dfdd9e2-07f5-485b-aedc-efb0b879a401",
   "metadata": {},
   "outputs": [],
   "source": [
    "#top department\n",
    "top_dept = (dept_counts.sort_values([\"user_id\", \"count\"], ascending=[True, False]).drop_duplicates(\"user_id\").set_index(\"user_id\")[\"department_id\"])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 21,
   "id": "e0778c79-70ea-4c57-a34b-b5a949ed2c1f",
   "metadata": {},
   "outputs": [],
   "source": [
    "instacart_active[\"top_dept\"] = instacart_active[\"user_id\"].map(top_dept)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 22,
   "id": "f9cd13f1-ffb5-4e11-a9de-521fb8008f6e",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "top_dept\n",
       "4.0     6380964\n",
       "16.0    1367507\n",
       "7.0      543317\n",
       "19.0     495036\n",
       "1.0      322636\n",
       "Name: count, dtype: int64"
      ]
     },
     "execution_count": 22,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "instacart_active[\"top_dept\"].value_counts().head()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 23,
   "id": "fa70127c-cd5d-47e1-a778-31ff25b0fd31",
   "metadata": {},
   "outputs": [],
   "source": [
    "departments = pd.read_csv(r\"C:\\Users\\shais\\Documents\\01-12-2026 Instacart Basket Analysis\\02 Data\\Original Data\\departments.csv\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 24,
   "id": "628132b7-8d09-451b-85e5-740c8e48c3ea",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>department_id</th>\n",
       "      <th>1</th>\n",
       "      <th>2</th>\n",
       "      <th>3</th>\n",
       "      <th>4</th>\n",
       "      <th>5</th>\n",
       "      <th>6</th>\n",
       "      <th>7</th>\n",
       "      <th>8</th>\n",
       "      <th>9</th>\n",
       "      <th>...</th>\n",
       "      <th>12</th>\n",
       "      <th>13</th>\n",
       "      <th>14</th>\n",
       "      <th>15</th>\n",
       "      <th>16</th>\n",
       "      <th>17</th>\n",
       "      <th>18</th>\n",
       "      <th>19</th>\n",
       "      <th>20</th>\n",
       "      <th>21</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>department</td>\n",
       "      <td>frozen</td>\n",
       "      <td>other</td>\n",
       "      <td>bakery</td>\n",
       "      <td>produce</td>\n",
       "      <td>alcohol</td>\n",
       "      <td>international</td>\n",
       "      <td>beverages</td>\n",
       "      <td>pets</td>\n",
       "      <td>dry goods pasta</td>\n",
       "      <td>...</td>\n",
       "      <td>meat seafood</td>\n",
       "      <td>pantry</td>\n",
       "      <td>breakfast</td>\n",
       "      <td>canned goods</td>\n",
       "      <td>dairy eggs</td>\n",
       "      <td>household</td>\n",
       "      <td>babies</td>\n",
       "      <td>snacks</td>\n",
       "      <td>deli</td>\n",
       "      <td>missing</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>1 rows × 22 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "  department_id       1      2       3        4        5              6  \\\n",
       "0    department  frozen  other  bakery  produce  alcohol  international   \n",
       "\n",
       "           7     8                9  ...            12      13         14  \\\n",
       "0  beverages  pets  dry goods pasta  ...  meat seafood  pantry  breakfast   \n",
       "\n",
       "             15          16         17      18      19    20       21  \n",
       "0  canned goods  dairy eggs  household  babies  snacks  deli  missing  \n",
       "\n",
       "[1 rows x 22 columns]"
      ]
     },
     "execution_count": 24,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "departments.head()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "290e0742-7b60-4f2f-9cda-cbcf613fb470",
   "metadata": {},
   "source": [
    "top department is 1) Produce, 2) dairy eggs, 3) beverages, 4) snakcs,  and 5) frozen"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "d4ebb6e8-beb1-4cd2-b925-4d1b1819a675",
   "metadata": {},
   "outputs": [],
   "source": [
    "instacart_active[\"customer_profile\"] = (\n",
    "    instacart_active[\"age_group\"] + \"|\" +\n",
    "    instacart_active[\"family_status\"] + \"|\" +\n",
    "    instacart_active[\"income_group\"] + \"|\" +\n",
    "    \"Dept \" + instacart_active[\"top_dept\"].astype(str))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "555ff3bb-867e-405a-873e-bdc1ded09ad0",
   "metadata": {},
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python [conda env:base] *",
   "language": "python",
   "name": "conda-base-py"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.13.9"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
